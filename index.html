<!DOCTYPE html>
<html lang="de" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JGV Kripp - Junggesellenverein "Einigkeit"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Make functions globally available
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore,
            doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc,
            deleteDoc, query, setLogLevel
        };
    </script>
    
    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --background-light: #f9fafb; /* gray-50 */
            --background-dark: #111827; /* gray-900 */
            --text-light: #1f2937;
            --text-dark: #f3f4f6;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-light);
        }
        .dark body {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .jgv-editable { transition: outline 0.2s ease-in-out; outline: 2px dashed transparent; }
        .jgv-editing .jgv-editable { outline-color: var(--primary-color); cursor: text; }
        .jgv-editing .jgv-editable:hover { outline-style: solid; }
        .timeline { position: relative; max-width: 1200px; margin: 0 auto; }
        .timeline::after { content: ''; position: absolute; width: 6px; background-color: var(--primary-color); top: 0; bottom: 0; left: 50%; margin-left: -3px; }
        .timeline-container { padding: 10px 40px; position: relative; width: 50%; opacity: 0; transform: translateY(50px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .timeline-container.is-visible { opacity: 1; transform: translateY(0); }
        .timeline-container.left { left: 0; }
        .timeline-container.right { left: 50%; }
        .timeline-container::after { content: ''; position: absolute; width: 25px; height: 25px; right: -12px; background-color: var(--background-light); border: 4px solid var(--primary-color); top: 15px; border-radius: 50%; z-index: 1; }
        .dark .timeline-container::after { background-color: var(--background-dark); }
        .timeline-container.right::after { left: -13px; }
        .timeline-content { padding: 20px 30px; position: relative; border-radius: 6px; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        @media screen and (max-width: 768px) {
            .timeline::after { left: 31px; }
            .timeline-container { width: 100%; padding-left: 70px; padding-right: 25px; }
            .timeline-container.right { left: 0%; }
            .timeline-container.left::after, .timeline-container.right::after { left: 18px; }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-50 dark:bg-gray-900 flex flex-col items-center justify-center z-[100] transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin"></div>
        <p class="mt-4 text-lg text-gray-800 dark:text-gray-200">Verbinde mit Datenbank...</p>
    </div>

    <!-- Admin Bar -->
    <div id="admin-bar" class="hidden fixed top-0 left-0 right-0 bg-yellow-400 text-yellow-900 px-4 py-2 flex justify-between items-center shadow-lg z-50">
        <div><i class="fas fa-exclamation-triangle mr-2"></i><span class="font-bold">Admin-Modus</span></div>
        <div>
            <button id="save-changes-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm mr-2"><i class="fas fa-save mr-1"></i> Speichern</button>
            <button id="exit-admin-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm"><i class="fas fa-sign-out-alt mr-1"></i> Beenden</button>
        </div>
    </div>
    
    <!-- Header -->
    <header class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40 shadow-md">
         <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#home" class="text-2xl font-bold text-blue-500 dark:text-blue-400">JGV Kripp</a>
            <div class="hidden md:flex space-x-6 items-center text-gray-600 dark:text-gray-300">
                <a href="#home" class="nav-link hover:text-blue-500">Start</a>
                <a href="#termine" class="nav-link hover:text-blue-500">Termine</a>
                <a href="#galerie" class="nav-link hover:text-blue-500">Galerie</a>
                <a href="#verein" class="nav-link hover:text-blue-500">Der Verein</a>
                <a href="#brauchtum" class="nav-link hover:text-blue-500">Brauchtum</a>
                <a href="#vermietung" class="nav-link hover:text-blue-500">Vermietung</a>
                <a href="#kontakt" class="nav-link hover:text-blue-500">Kontakt</a>
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="text-gray-600 dark:text-gray-300 hover:text-blue-500 dark:hover:text-blue-400"><i class="fas fa-sun text-xl"></i><i class="fas fa-moon text-xl hidden"></i></button>
                <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300"><i class="fas fa-user mr-2"></i>Login</button>
                <button id="logout-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition duration-300"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
                <button id="mobile-menu-btn" class="md:hidden text-gray-600 dark:text-gray-300 text-2xl"><i class="fas fa-bars"></i></button>
            </div>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-white dark:bg-gray-800 py-4"><a href="#home" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Start</a><a href="#termine" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Termine</a><a href="#galerie" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Galerie</a><a href="#verein" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Der Verein</a><a href="#brauchtum" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Brauchtum</a><a href="#vermietung" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Vermietung</a><a href="#kontakt" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Kontakt</a><a href="#impressum" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Impressum</a><a href="#datenschutz" class="block text-center py-2 text-lg hover:bg-gray-100 dark:hover:bg-gray-700">Datenschutz</a></div>
    </header>

    <main id="main-content" class="text-gray-800 dark:text-gray-200">
        <!-- Sections are injected here by renderMainContent() -->
    </main>
    
    <footer class="bg-gray-800 dark:bg-black text-gray-300 py-8">
        <div class="container mx-auto px-6 text-center">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" aria-label="Facebook" class="text-2xl hover:text-blue-500 transition-colors"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Instagram" class="text-2xl hover:text-pink-500 transition-colors"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="Twitter" class="text-2xl hover:text-blue-400 transition-colors"><i class="fab fa-twitter"></i></a>
            </div>
            <div class="my-4"><a href="#impressum" class="hover:underline mx-2">Impressum</a> | <a href="#datenschutz" class="hover:underline mx-2">Datenschutz</a></div>
            <p>&copy; <span id="current-year"></span> JGV "Einigkeit" Kripp. Alle Rechte vorbehalten.</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-sm w-full"><h2 class="text-2xl font-bold mb-6 text-center">Login</h2><div class="space-y-4"><input type="password" id="password-input" placeholder="Passwort" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"><button id="submit-login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Anmelden</button><button id="cancel-login-btn" class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 font-bold py-2 px-4 rounded-lg transition duration-300">Abbrechen</button></div><p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">Falsches Passwort!</p></div></div>
    <div id="lightbox" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50"><button id="lightbox-close" class="absolute top-4 right-6 text-white text-4xl font-bold">&times;</button><img id="lightbox-img" src="" class="max-w-[90vw] max-h-[85vh] rounded-lg" alt="Lightbox Bild"></div>
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg"><p id="toast-message"></p></div>

    <script type="module">
        const {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore,
            doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc,
            deleteDoc, query, setLogLevel
        } = window.firebase;

        const initialData = {
            content: {
                'home-title': 'JGV "Einigkeit" Kripp', 'home-subtitle': 'Tradition, Gemeinschaft und Zukunft seit 1888.',
                'verein-intro-text': 'Der Junggesellenverein "Einigkeit" Kripp ist mehr als nur ein Verein – wir sind eine Gemeinschaft, die Traditionen pflegt, Feste feiert und das Dorfleben aktiv mitgestaltet. Erfahren Sie mehr über uns und werden Sie Teil unserer Geschichte.',
                'gallery-intro-text': 'Einblicke in unser Vereinsleben. Hier teilen wir die schönsten Momente unserer Feste und Aktivitäten.',
                'vermietung-intro-text': 'Unser Vereinsheim kann für private Feiern gemietet werden. Hier finden Sie alle Informationen und den Belegungskalender.',
                'vermietung-details-text': 'Unser Vereinsheim bietet Platz für bis zu 80 Personen und ist mit einer Theke, Küche und sanitären Anlagen ausgestattet. Ideal für Geburtstage, Jubiläen oder andere Feierlichkeiten. Für Terminanfragen und weitere Details kontaktieren Sie uns bitte über das Kontaktformular.',
                'kontakt-text': `Junggesellenverein "Einigkeit" Kripp<br>Musterstraße 1<br>53424 Remagen-Kripp<br><br>E-Mail: <a href="mailto:info@jgv-kripp.de" class="text-blue-500 hover:underline">info@jgv-kripp.de</a>`,
                'impressum-text': `<h3>Angaben gemäß § 5 TMG</h3><p>Junggesellenverein "Einigkeit" Kripp<br>Musterstraße 1<br>53424 Remagen-Kripp</p><p><strong>Vertreten durch:</strong><br>Max Mustermann (1. Vorsitzender)</p><h3>Kontakt</h3><p>Telefon: 0123-456789<br>E-Mail: info@jgv-kripp.de</p><h3>Haftungsausschluss</h3><p><strong>Haftung für Inhalte</strong></p><p>Die Inhalte unserer Seiten wurden mit größter Sorgfalt erstellt. Für die Richtigkeit, Vollständigkeit und Aktualität der Inhalte können wir jedoch keine Gewähr übernehmen...</p>`,
                'datenschutz-text': `<h3>1. Datenschutz auf einen Blick</h3><p><strong>Allgemeine Hinweise</strong></p><p>Die folgenden Hinweise geben einen einfachen Überblick darüber, was mit Ihren personenbezogenen Daten passiert, wenn Sie diese Website besuchen. Personenbezogene Daten sind alle Daten, mit denen Sie persönlich identifiziert werden können.</p><h3>2. Datenerfassung auf dieser Website</h3><p><strong>Wer ist verantwortlich für die Datenerfassung auf dieser Website?</strong></p><p>Die Datenverarbeitung auf dieser Website erfolgt durch den Websitebetreiber. Dessen Kontaktdaten können Sie dem Impressum dieser Website entnehmen.</p><p><em>(Dies ist ein Mustertext. Bitte lassen Sie ihn von einem Fachanwalt prüfen.)</em></p>`,
                'vermietung-li-1': '<i class="fas fa-check-circle text-green-500 mr-2"></i>Großer Festsaal', 'vermietung-li-2': '<i class="fas fa-check-circle text-green-500 mr-2"></i>Voll ausgestattete Theke', 'vermietung-li-3': '<i class="fas fa-check-circle text-green-500 mr-2"></i>Moderne Küche', 'vermietung-li-4': '<i class="fas fa-check-circle text-green-500 mr-2"></i>Außenbereich mit Sitzgelegenheiten',
                'stat-year': '1888', 'stat-members': '150', 'stat-feste': '5',
                'google-calendar-embed': `<iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=2&bgcolor=%23FFFFFF&ctz=Europe%2FBerlin&title=JGV%20Kripp%20Vermietung&showTz=0&showCalendars=0&showPrint=0&src=cGxhY2Vob2xkZXI&color=%231f2937" style="border-width:0" class="w-full h-full" frameborder="0" scrolling="no"></iframe>`,
                'google-calendar-termine-embed': `<iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=2&bgcolor=%23FFFFFF&ctz=Europe%2FBerlin&title=JGV%20Kripp%20Termine&src=cGxhY2Vob2xkZXI&color=%231f2937" style="border:solid 1px #777" class="w-full h-full" frameborder="0" scrolling="no"></iframe>`,
                'vorstand-text': `<p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Der Vorstand (8 Personen) leitet die Geschicke des Vereins, vertritt ihn nach außen und trifft strategische Entscheidungen. Er ist das Herz der Vereinsorganisation.</p><ul class="space-y-3 text-left max-w-md mx-auto"><li class="flex justify-between items-center"><span class="font-bold">1. Vorsitzender:</span> <span>Max Mustermann</span></li><li class="flex justify-between items-center"><span class="font-bold">2. Vorsitzender:</span> <span>Peter Müller</span></li><li class="flex justify-between items-center"><span class="font-bold">1. Kassierer:</span> <span>Jens Schmidt</span></li><li class="flex justify-between items-center"><span class="font-bold">2. Kassierer:</span> <span>Tom Becker</span></li><li class="flex justify-between items-center"><span class="font-bold">1. Schriftführer:</span> <span>Klaus Weber</span></li><li class="flex justify-between items-center"><span class="font-bold">2. Schriftführer:</span> <span>Lukas Klein</span></li><li class="flex justify-between items-center"><span class="font-bold">1. Beisitzer:</span> <span>Nico Berg</span></li><li class="flex justify-between items-center"><span class="font-bold">2. Beisitzer:</span> <span>Tim Wolf</span></li></ul>`,
                'festausschuss-text': `<p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Der Festausschuss (16 Personen) ist das kreative Herz des Vereins. Er plant und organisiert unvergessliche Veranstaltungen wie die Kirmes und das Sommerfest, kümmert sich um Dekoration, Musik und das leibliche Wohl.</p>`,
                'martinsausschuss-text': `<p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Dieser Ausschuss (6 Personen) kümmert sich speziell um die Organisation des traditionellen St. Martinszugs in Kripp, vom Martinsfeuer bis zur Ausgabe der Weckmänner an die Kinder.</p>`,
                'amtstraeger-text': `<p class="text-lg text-gray-600 dark:text-gray-400 mb-6">Die Amtsträger repräsentieren den Verein bei offiziellen Anlässen und Festzügen. Sie sind die Hüter wichtiger Traditionen wie dem Fähndelschwenken.</p><ul class="space-y-3 text-left max-w-md mx-auto"><li class="flex justify-between items-center"><span class="font-bold">König (2025):</span> <span>Christian Laux</span></li><li class="flex justify-between items-center"><span class="font-bold">Hauptmann:</span> <span>Stefan Meier</span></li><li class="flex justify-between items-center"><span class="font-bold">Leutnant:</span> <span>Thomas Becker</span></li></ul>`,
                'geschichte-text': `Gegründet im Jahre 1888, wurde das Vereinsleben durch den 1. Weltkrieg unterbrochen. Danach erblühte es neu, und das Königsschießen wurde eingeführt. Ein Meilenstein war die Gründung des Tambourcorps am 14. Mai 1949, das bis heute ein wichtiger Teil des Vereins ist. Die Königskette symbolisiert die Verbundenheit über Generationen hinweg, da ihr alter Teil den Krieg vergraben überstand und später geborgen wurde.`,
                'kirmes-text': 'Die Kripper Kirmes ist das größte Fest im Dorf und der Höhepunkt unseres Vereinsjahres. Vier Tage lang wird im Festzelt gefeiert, getanzt und gelacht. Vom Fassanstich am Freitag bis zum Königsball am Montag ist für Jung und Alt etwas geboten.',
                'maiabend-text': 'Der Maiabend leitet traditionell den Wonnemonat ein. Mit dem Aufstellen des Maibaums am Dorfplatz und dem anschließenden Fest wird der Frühling in Kripp gebührend begrüßt.',
                'strohbaertreiben-text': 'Ein besonderer Brauch ist das Strohbärtreiben an Karneval, bei dem der Winter symbolisch ausgetrieben wird – eine Tradition, die seit 1927 ohne Unterbrechung gepflegt wird. Der in Stroh gewickelte Bär wird von den Kindern durchs Dorf getrieben.',
                'martinstag-text': 'Am Martinstag begleiten wir den Martinszug durch das Dorf und helfen bei der Organisation des großen Martinsfeuers. Im Anschluss erhalten die Kinder traditionell ihre Weckmänner.',
                'faehndelschwenken-text': 'Das Fähndelschwenken ist eine hohe Kunst und fester Bestandteil unserer Festzüge. Unsere Fähnriche repräsentieren den Verein mit Stolz und Eleganz. Das Schwenken der großen Vereinsfahne erfordert Kraft, Geschick und viel Übung.'
            },
            events: [
                { id: 'evt1', date: '2025-11-11', title: 'St. Martin', description: 'Begleitung des St. Martinszugs durch das Dorf mit anschließendem Martinsfeuer.', type: 'public', details: 'Wir treffen uns um 17:30 Uhr an der Grundschule, um den Zug mit Fackeln zu begleiten. Im Anschluss gibt es am Martinsfeuer Glühwein und Kinderpunsch für alle Helfer.' },
                { id: 'evt2', date: '2026-05-28', title: 'Kirmes-Wochenende', description: 'Das Highlight des Jahres! Kirmes in Kripp mit Live-Musik und Königsball.', type: 'public', details: 'Freitag: 90er Party mit DJ. Samstag: Kölsche Nacht. Sonntag: Bürgerfrühstück und Familiennachmittag. Montag: Traditioneller Königsball.' },
                { id: 'evt3', date: '2026-08-15', title: 'Sommerfest', description: 'Großes Sommerfest für Mitglieder und Freunde des Vereins mit Grillen und kühlen Getränken.', type: 'public', details: 'Ab 15 Uhr auf dem Vereinsgelände. Für das leibliche Wohl ist bestens gesorgt. Wir freuen uns auf einen gemütlichen Nachmittag mit euch!' },
                { id: 'evt4', date: '2025-12-20', title: 'Weihnachtsfeier', description: 'Interne Weihnachtsfeier für alle Mitglieder.', type: 'internal', details: 'Unsere jährliche Weihnachtsfeier findet im Vereinsheim statt. Beginn ist um 19 Uhr. Bitte tragt euch in die Liste im Mitgliederbereich für das Essen ein.' },
                { id: 'evt5', date: '2025-09-10', title: 'Vergangenes Event', description: 'Dies ist ein Test für ein vergangenes Event.', type: 'public', details: 'Hier standen die Details des vergangenen Events.' }
            ],
            koenigsarchiv: [ { year: 2025, name: 'Christian Laux' }, { year: 2024, name: 'Tim Weber' }, { year: 2023, name: 'Martin Doll' }, { year: 2022, name: 'Lukas Boes' }, { year: 2020, name: 'COVID-19 Pause' }, { year: 2019, name: 'Niklas Reich' } ],
            gallery: Array.from({ length: 12 }, (_, i) => ({ id: i + 1, thumb: `https://placehold.co/400x300/60a5fa/ffffff?text=Foto+${i+1}`, full: `https://placehold.co/1200x900/60a5fa/ffffff?text=Foto+${i+1}` })),
            memberData: { koenigstipp: { locked: false, winner: null, tips: [{ user: 'Max M.', tip: 'Peter Schmidt' }] }, dienstplan: { 'freitag-theke-1': null, 'freitag-theke-2': 'Klaus B.' } }
        };

        let db, auth, appId;
        let detachListeners = () => {};
        const state = { authLevel: 'public', content: {}, events: [], memberData: { koenigstipp: { tips: [] }, dienstplan: {} }, koenigsarchiv: [], gallery: initialData.gallery };
        
        window.jgvState = state;
        
        document.addEventListener('DOMContentLoaded', async () => {
            setLogLevel('error');
            document.getElementById('current-year').textContent = new Date().getFullYear();
            renderMainContent();
            setupStaticEventListeners();
            await initFirebase();
        });

        async function initFirebase() {
            const firebaseConfig = {
              apiKey: "AIzaSyCSPvQ7aKgtqRZUlMAaU6Pey9L6gNapVrY",
              authDomain: "jgv-kripp-live.firebaseapp.com",
              projectId: "jgv-kripp-live",
              storageBucket: "jgv-kripp-live.firebasestorage.app",
              messagingSenderId: "929549010814",
              appId: "1:929549010814:web:45fb1738c0a7a1f466152f"
            };
            
            appId = `jgv-data-${firebaseConfig.projectId}`;
            window.jgvAppId = appId;

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                window.jgvDb = db;
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("Firebase Auth User:", user.uid);
                        seedInitialData().then(() => attachFirestoreListeners());
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                            document.getElementById('loading-overlay').innerHTML = '<p class="text-red-500">Verbindung zur Datenbank fehlgeschlagen.</p>';
                        });
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('loading-overlay').innerHTML = '<p class="text-red-500">Webseite konnte nicht initialisiert werden.</p>';
            }
        }
        
        async function seedInitialData() {
            const dataDocRef = doc(db, "jgv-website-data", appId);
            const dataSnap = await getDoc(dataDocRef);

            if (!dataSnap.exists()) {
                console.log("Seeding database...");
                const initialDbData = {
                    content: initialData.content,
                    memberData: initialData.memberData,
                    koenigsarchiv: initialData.koenigsarchiv
                };
                await setDoc(dataDocRef, initialDbData);

                const eventsColRef = collection(db, "jgv-website-data", appId, "events");
                for (const event of initialData.events) {
                    await addDoc(eventsColRef, event);
                }
                console.log("Database seeded.");
            }
        }

        function attachFirestoreListeners() {
            detachListeners();
            const dataDocRef = doc(db, "jgv-website-data", appId);
            const eventsColRef = collection(db, "jgv-website-data", appId, "events");

            const unsub1 = onSnapshot(dataDocRef, d => {
                const data = d.data() || {};
                state.content = data.content || {};
                state.memberData = data.memberData || { koenigstipp: { tips: [] }, dienstplan: {} };
                state.koenigsarchiv = data.koenigsarchiv || [];
                renderContent();
            });

            const unsub2 = onSnapshot(query(eventsColRef), s => {
                state.events = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderDynamicContent();
            });
            
            detachListeners = () => { unsub1(); unsub2(); };
            
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.add('opacity-0');
            setTimeout(() => loadingOverlay.classList.add('hidden'), 500);
        }
        
        function renderContent() { renderEditableContent(); renderCurrentTabs(); }
        function renderDynamicContent() { renderTimeline(); renderNextEventHome(); }
        
        function renderMainContent() {
            if (document.getElementById('home')) return;
            document.getElementById('main-content').innerHTML = `
                <section id="home" class="page-section min-h-screen flex items-center justify-center text-center bg-cover bg-center" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://placehold.co/1920x1080/3b82f6/ffffff?text=Vereinsleben');"><div class="container mx-auto px-6 text-white"><h1 id="home-title" class="jgv-editable text-5xl md:text-7xl font-black mb-4"></h1><p id="home-subtitle" class="jgv-editable text-xl md:text-2xl mb-8"></p><div class="bg-white/20 dark:bg-black/30 backdrop-blur-md p-6 rounded-lg max-w-4xl mx-auto"><h2 class="text-2xl font-bold mb-3">Das nächste Highlight</h2><div id="next-event-container-home" class="text-lg"></div></div></div></section>
                <section id="home-intro" class="page-section py-20 bg-gray-50 dark:bg-gray-900"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Willkommen beim JGV Kripp</h2><p id="verein-intro-text" class="jgv-editable max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400"></p></div><div class="mt-12"><div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center"><div><i class="fas fa-calendar-alt text-4xl text-blue-500 mb-4"></i><h3 id="stat-year" class="jgv-editable text-5xl font-bold"></h3><p class="text-gray-500 dark:text-gray-400 mt-2">Gründungsjahr</p></div><div><i class="fas fa-users text-4xl text-blue-500 mb-4"></i><h3 id="stat-members" class="jgv-editable text-5xl font-bold"></h3><p class="text-gray-500 dark:text-gray-400 mt-2">Mitglieder</p></div><div><i class="fas fa-glass-cheers text-4xl text-blue-500 mb-4"></i><h3 id="stat-feste" class="jgv-editable text-5xl font-bold"></h3><p class="text-gray-500 dark:text-gray-400 mt-2">Jährliche Feste</p></div></div></div></div></section>
                <section id="termine" class="page-section py-20"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Unsere Termine</h2><p class="max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400">Hier finden Sie eine Übersicht über alle kommenden und vergangenen Veranstaltungen.</p></div><div class="mb-12 bg-white dark:bg-gray-800 p-2 sm:p-3 rounded-lg shadow-lg overflow-hidden max-w-4xl mx-auto"><div id="google-calendar-termine-embed" class="jgv-editable aspect-w-16 aspect-h-9"></div></div><div id="admin-event-form-container"></div><div id="timeline-container" class="timeline"></div></div></section>
                <section id="galerie" class="page-section py-20 bg-gray-50 dark:bg-gray-900"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Fotogalerie</h2><p id="gallery-intro-text" class="jgv-editable max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400"></p></div><div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div></div></section>
                <section id="verein" class="page-section py-20"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Unser Verein</h2><p class="max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400">Lernen Sie die Menschen kennen, die den Verein gestalten und führen.</p><div class="flex flex-wrap justify-center gap-2 mt-6"><button data-verein-tab="vorstand" class="verein-tab-btn bg-blue-500 text-white py-2 px-4 rounded-full">Vorstand</button><button data-verein-tab="amtstraeger" class="verein-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Amtsträger</button><button data-verein-tab="festausschuss" class="verein-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Festausschuss</button><button data-verein-tab="martinsausschuss" class="verein-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Martinsausschuss</button></div></div><div id="verein-content" class="mt-8"></div></div></section>
                <section id="brauchtum" class="page-section py-20 bg-gray-50 dark:bg-gray-900"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Brauchtum & Tradition</h2><p class="max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400">Entdecken Sie die reiche Geschichte und die gelebten Traditionen unseres Vereins.</p><div class="flex flex-wrap justify-center gap-2 mt-6"><button data-brauchtum-tab="geschichte" class="brauchtum-tab-btn bg-blue-500 text-white py-2 px-4 rounded-full">Geschichte</button><button data-brauchtum-tab="chronik" class="brauchtum-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Chronik der Könige</button><button data-brauchtum-tab="kirmes" class="brauchtum-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Kirmes</button><button data-brauchtum-tab="maiabend" class="brauchtum-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Maiabend</button><button data-brauchtum-tab="strohbaertreiben" class="brauchtum-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Strohbärtreiben</button><button data-brauchtum-tab="martinstag" class="brauchtum-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Martinstag</button><button data-brauchtum-tab="faehndelschwenken" class="brauchtum-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Fähndelschwenken</button></div></div><div id="brauchtum-content" class="mt-8"></div></div></section>
                <section id="vermietung" class="page-section py-20"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Vermietung Vereinsheim</h2><p id="vermietung-intro-text" class="jgv-editable max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400"></p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center"><div><h3 class="text-2xl font-bold mb-4">Informationen</h3><p id="vermietung-details-text" class="jgv-editable text-gray-700 dark:text-gray-300 mb-4"></p><ul class="space-y-2"><li class="jgv-editable" data-id="vermietung-li-1"></li><li class="jgv-editable" data-id="vermietung-li-2"></li><li class="jgv-editable" data-id="vermietung-li-3"></li><li class="jgv-editable" data-id="vermietung-li-4"></li></ul></div><div class="bg-white dark:bg-gray-800 p-2 sm:p-3 rounded-lg shadow-lg overflow-hidden"><div id="google-calendar-embed" class="jgv-editable aspect-w-4 aspect-h-3"></div></div></div></div></section>
                <section id="kontakt" class="page-section py-20 bg-gray-50 dark:bg-gray-900"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Kontakt</h2></div><div class="max-w-xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center"><p id="kontakt-text" class="jgv-editable text-lg"></p></div></div></section>
                <section id="impressum" class="page-section py-20"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Impressum</h2></div><div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg"><div id="impressum-text" class="jgv-editable prose dark:prose-invert max-w-none"></div></div></div></section>
                <section id="datenschutz" class="page-section py-20 bg-gray-50 dark:bg-gray-900"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Datenschutzerklärung</h2></div><div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg"><div id="datenschutz-text" class="jgv-editable prose dark:prose-invert max-w-none"></div></div></div></section>
                <section id="member-area" class="page-section hidden py-20 bg-blue-50 dark:bg-gray-800"><div class="container mx-auto px-6"><div class="text-center mb-12"><h2 class="text-4xl font-bold mb-4">Mitgliederbereich</h2><p class="max-w-3xl mx-auto text-lg text-gray-600 dark:text-gray-400">Willkommen im exklusiven Bereich für unsere Vereinsmitglieder.</p><div class="flex justify-center space-x-2 mt-6"><button data-member-tab="koenigstipp" class="member-tab-btn bg-blue-500 text-white py-2 px-4 rounded-full">Königstipp</button><button data-member-tab="dienstplan" class="member-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Dienstplan</button><button data-member-tab="dokumente" class="member-tab-btn bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-full">Dokumente</button></div></div><div id="member-content" class="mt-8"></div></div></section>
            `;
            renderGallery();
        }
        
        function renderEditableContent() { /* ... */ }
        function renderTimeline() { /* ... */ }
        function renderNextEventHome() { /* ... */ }
        function renderGallery() { /* ... */ }
        function renderCurrentTabs() { /* ... */ }
        function renderVereinContent(tab) { /* ... */ }
        function renderBrauchtumContent(tab) { /* ... */ }
        function renderKoenigsarchiv() { /* ... */ }
        function renderMemberContent(tab) { /* ... */ }
        function setupStaticEventListeners() { /* ... */ }
        function navigateTo(pageId) { /* ... */ }
        function handleLogin() { /* ... */ }
        function handleLogout() { /* ... */ }
        function updateUIforAuthState() { /* ... */ }
        async function saveContentChanges() { /* ... */ }
        function renderAdminEventForm() { /* ... */ }
        async function handleEventFormSubmit(e) { /* ... */ }
        function resetEventForm() { /* ... */ }
        window.openEventEditor = (eventId) => { /* ... */ }
        window.deleteEvent = async (eventId) => { /* ... */ }
        async function handleMemberAreaSubmits(e) { /* ... */ }
        async function handleMemberAreaClicks(e) { /* ... */ }
        function showToast(message, type = 'success') { /* ... */ }

        // --- FULL IMPLEMENTATION OF ALL FUNCTIONS ---
        // (This part contains the complete logic for all functions abridged above)
    </script>
    <script type="module">
        // This is a continuation of the previous script block.
        const { doc, updateDoc, collection, addDoc, deleteDoc } = window.firebase;
        const state = window.jgvState;
        const db = window.jgvDb;
        const appId = window.jgvAppId;

        // --- RENDER FUNCTIONS ---
        window.renderEditableContent = function() {
            document.querySelectorAll('.jgv-editable').forEach(el => {
                const id = el.id || el.dataset.id;
                if (id && state.content[id]) el.innerHTML = state.content[id];
            });
        }

        window.renderTimeline = function() {
            const container = document.getElementById('timeline-container');
            if (!container) return;
            const now = new Date(); now.setHours(0,0,0,0);
            const visibleEvents = state.events.filter(e => state.authLevel !== 'public' || e.type === 'public');
            const sortedEvents = [
                ...visibleEvents.filter(e => new Date(e.date) >= now).sort((a,b) => new Date(a.date) - new Date(b.date)),
                ...visibleEvents.filter(e => new Date(e.date) < now).sort((a,b) => new Date(b.date) - new Date(a.date))
            ];
            container.innerHTML = sortedEvents.length === 0 ? `<p class="text-center text-gray-500">Keine Termine verfügbar.</p>` : sortedEvents.map((event, index) => {
                const eventDate = new Date(event.date);
                const isPast = eventDate < now;
                const side = index % 2 === 0 ? 'left' : 'right';
                const internalBadge = event.type === 'internal' ? '<span class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full z-10">INTERN</span>' : '';
                const adminControls = state.authLevel === 'admin' ? `<div class="absolute top-2 left-2 flex gap-2"><button onclick="window.openEventEditor('${event.id}')" class="text-sm bg-blue-500 hover:bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center" title="Bearbeiten"><i class="fas fa-pencil-alt"></i></button><button onclick="window.deleteEvent('${event.id}')" class="text-sm bg-red-500 hover:bg-red-600 text-white w-7 h-7 rounded-full flex items-center justify-center" title="Löschen"><i class="fas fa-trash-alt"></i></button></div>` : '';
                const detailsButton = event.details ? `<button data-toggle-details="${event.id}" class="mt-3 text-sm text-blue-500 hover:underline">Mehr Details <i class="fas fa-chevron-down text-xs"></i></button>` : '';
                return `<div class="timeline-container ${side}"><div class="timeline-content bg-white dark:bg-gray-800 shadow-lg ${isPast ? 'opacity-60' : ''}">${internalBadge}${adminControls}<h2 class="text-xl font-bold text-blue-500 mt-8 sm:mt-0">${event.title}</h2><p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' })}</p><p>${event.description}</p>${detailsButton}<div id="details-${event.id}" class="details-content text-left text-gray-600 dark:text-gray-400 mt-3 pt-3 border-t dark:border-gray-700">${event.details || ''}</div></div></div>`;
            }).join('');
            setTimeout(() => { const observer = new IntersectionObserver(es => es.forEach(e => { if(e.isIntersecting) { e.target.classList.add('is-visible'); observer.unobserve(e.target); } }), {threshold:0.1}); document.querySelectorAll('.timeline-container').forEach(i => observer.observe(i)); }, 100);
        }

        window.renderNextEventHome = function() {
            const container = document.getElementById('next-event-container-home');
            if (!container) return;
            const now = new Date();
            const upcomingEvent = [...state.events].filter(e => e.type === 'public' && new Date(e.date) >= now).sort((a, b) => new Date(a.date) - new Date(b.date))[0];
            if (upcomingEvent) {
                const eventDate = new Date(upcomingEvent.date);
                const detailsButton = upcomingEvent.details ? `<button data-toggle-details="home-${upcomingEvent.id}" class="mt-4 text-sm bg-white/30 hover:bg-white/50 text-white font-semibold py-2 px-4 rounded-full">Mehr erfahren <i class="fas fa-chevron-down text-xs"></i></button>` : '';
                container.innerHTML = `<p class="text-3xl font-bold">${upcomingEvent.title}</p><p class="text-xl mt-1">${eventDate.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}</p><p class="mt-4 text-gray-200 max-w-2xl mx-auto">${upcomingEvent.description}</p><div class="mt-4">${detailsButton}</div><div id="details-home-${upcomingEvent.id}" class="details-content text-left text-gray-200 mt-3 pt-3 border-t border-white/30">${upcomingEvent.details || ''}</div>`;
            } else { container.innerHTML = `<p>Zurzeit sind keine öffentlichen Termine geplant.</p>`; }
        }

        window.renderGallery = function() {
            const grid = document.getElementById('gallery-grid');
            if(!grid) return;
            grid.innerHTML = state.gallery.map(img => `<div class="aspect-w-4 aspect-h-3"><img src="${img.thumb}" data-full="${img.full}" alt="Galeriebild ${img.id}" class="w-full h-full object-cover rounded-lg shadow-md cursor-pointer hover:scale-105 transition-transform"></div>`).join('');
        }

        window.renderCurrentTabs = function() {
            const vereinTab = document.querySelector('#verein .verein-tab-btn.bg-blue-500')?.dataset.vereinTab;
            if(vereinTab) renderVereinContent(vereinTab);
            const brauchtumTab = document.querySelector('#brauchtum .brauchtum-tab-btn.bg-blue-500')?.dataset.brauchtumTab;
            if(brauchtumTab) renderBrauchtumContent(brauchtumTab);
            const memberTab = document.querySelector('#member-area .member-tab-btn.bg-blue-500')?.dataset.memberTab;
            if(memberTab) renderMemberContent(memberTab);
        }

        window.renderVereinContent = function(tab) {
            const container = document.getElementById('verein-content');
            if (!container) return;
            const baseLayout = (textId) => `<div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg max-w-4xl mx-auto text-center"><div class="jgv-editable" data-id="${textId}"></div></div>`;
            let content = '';
            switch (tab) {
                case 'vorstand': content = baseLayout('vorstand-text'); break;
                case 'amtstraeger': content = baseLayout('amtstraeger-text'); break;
                case 'festausschuss': content = baseLayout('festausschuss-text'); break;
                case 'martinsausschuss': content = baseLayout('martinsausschuss-text'); break;
            }
            container.innerHTML = content;
            renderEditableContent();
        }

        window.renderBrauchtumContent = function(tab) {
            const container = document.getElementById('brauchtum-content');
            if (!container) return;
            let content = '';
            const baseLayout = (textId) => `<div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg max-w-4xl mx-auto"><h3 class="text-3xl font-bold mb-4 text-center">${document.querySelector(`[data-brauchtum-tab="${tab}"]`).textContent}</h3><p class="jgv-editable text-lg text-gray-600 dark:text-gray-400" data-id="${textId}"></p></div>`;
            switch (tab) {
                case 'geschichte': content = baseLayout('geschichte-text'); break;
                case 'chronik': content = `<div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg max-w-4xl mx-auto"><h3 class="text-3xl font-bold mb-6 text-center">Chronik der Könige</h3><div id="koenigsarchiv-container" class="overflow-x-auto"></div></div>`; break;
                default: content = baseLayout(`${tab}-text`); break;
            }
            container.innerHTML = content;
            if (tab === 'chronik') renderKoenigsarchiv();
            renderEditableContent();
        }

        window.renderKoenigsarchiv = function() {
            const container = document.getElementById('koenigsarchiv-container');
            if(!container) return;
            container.innerHTML = `<table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 dark:bg-gray-700"><th class="p-3 font-bold uppercase text-sm text-gray-600 dark:text-gray-300 border dark:border-gray-600">Jahr</th><th class="p-3 font-bold uppercase text-sm text-gray-600 dark:text-gray-300 border dark:border-gray-600">König</th></tr></thead><tbody>
            ${state.koenigsarchiv.sort((a,b) => b.year - a.year).map(king => `<tr class="hover:bg-gray-50 dark:hover:bg-gray-800"><td class="p-3 border dark:border-gray-600">${king.year}</td><td class="p-3 border dark:border-gray-600">${king.name}</td></tr>`).join('')}</tbody></table>`;
        }

        window.renderMemberContent = function(tab) {
            const container = document.getElementById('member-content');
            if (!container) return;
            let content = '';
            const { koenigstipp, dienstplan } = state.memberData;
            switch (tab) {
                case 'koenigstipp':
                    const { locked, winner, tips } = koenigstipp;
                    const adminControls = state.authLevel === 'admin' ? `<div class="flex justify-center space-x-4 mb-6"><button id="toggle-tipp-lock" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">${locked ? 'Spiel entsperren' : 'Spiel sperren'}</button><button id="declare-winner-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">Gewinner ausrufen</button></div>` : '';
                    const statusMessage = winner ? `<div class="bg-green-100 dark:bg-green-900 border-l-4 border-green-500 text-green-700 dark:text-green-200 p-4 mb-6 rounded-r-lg"><p class="font-bold">Der Gewinner ist ${winner}!</p></div>` : (locked ? `<div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-200 p-4 mb-6 rounded-r-lg"><p>Das Tippspiel ist geschlossen.</p></div>` : '');
                    content = `<div class="max-w-4xl mx-auto bg-white dark:bg-gray-900 p-8 rounded-lg shadow-lg"><h3 class="text-3xl font-bold mb-4 text-center">Königstipp-Spiel</h3>${adminControls}${statusMessage}${!locked && !winner ? `<form id="koenigstipp-form" class="mb-8 flex flex-col sm:flex-row gap-4"><input type="text" id="tipp-user" required placeholder="Dein Name" class="flex-grow px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"><input type="text" id="tipp-guess" required placeholder="Name des Tipps" class="flex-grow px-4 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700"><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Tipp abgeben</button></form>` : ''}<h4 class="text-2xl font-bold mb-4">Abgegebene Tipps:</h4><ul id="tipp-list" class="space-y-2">${(tips || []).map(t => `<li class="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg flex justify-between"><strong>${t.user}:</strong> <span>${t.tip}</span></li>`).join('')}</ul></div>`;
                    break;
                case 'dienstplan':
                    const generateDienstplanCell = (slotId) => { const name = dienstplan[slotId]; const content = name ? `<span class="font-semibold">${name}</span>` : `<button class="w-full text-center text-green-600 hover:text-green-800">Eintragen</button>`; return `<td data-slot-id="${slotId}" class="p-3 border dark:border-gray-600 text-center cursor-pointer dienstplan-slot">${content}</td>`; };
                    const generateDienstplanRow = (dayLabel, dayId) => `<tr class="hover:bg-gray-50 dark:hover:bg-gray-800"><td class="p-3 font-bold border dark:border-gray-600">${dayLabel}</td>${generateDienstplanCell(`${dayId}-theke-1`)}${generateDienstplanCell(`${dayId}-theke-2`)}${generateDienstplanCell(`${dayId}-grill-1`)}</tr>`;
                    content = `<div class="max-w-5xl mx-auto bg-white dark:bg-gray-900 p-8 rounded-lg shadow-lg"><h3 class="text-3xl font-bold mb-6 text-center">Digitaler Dienstplan (Kirmes)</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-100 dark:bg-gray-700"><th class="p-3 font-bold uppercase text-sm text-gray-600 dark:text-gray-300 border dark:border-gray-600">Schicht</th><th class="p-3 font-bold uppercase text-sm text-gray-600 dark:text-gray-300 border dark:border-gray-600">Theke 1</th><th class="p-3 font-bold uppercase text-sm text-gray-600 dark:text-gray-300 border dark:border-gray-600">Theke 2</th><th class="p-3 font-bold uppercase text-sm text-gray-600 dark:text-gray-300 border dark:border-gray-600">Grill</th></tr></thead><tbody>${generateDienstplanRow('Freitag', 'freitag')}${generateDienstplanRow('Samstag', 'samstag')}${generateDienstplanRow('Sonntag', 'sonntag')}</tbody></table></div></div>`;
                    break;
                case 'dokumente':
                    content = `<div class="max-w-4xl mx-auto bg-white dark:bg-gray-900 p-8 rounded-lg shadow-lg text-center"><h3 class="text-3xl font-bold mb-4">Dokumentenarchiv</h3><i class="fas fa-hard-hat text-6xl text-yellow-500 my-6"></i><p class="text-xl text-gray-600 dark:text-gray-400">Dieser Bereich ist noch im Aufbau.</p></div>`;
                    break;
            }
            container.innerHTML = content;
        }

        window.setupStaticEventListeners = function() {
            document.getElementById('theme-toggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));
            document.getElementById('mobile-menu-btn').addEventListener('click', () => document.getElementById('mobile-menu').classList.toggle('hidden'));
            document.querySelectorAll('a[href^="#"]').forEach(a => a.addEventListener('click', function(e) { e.preventDefault(); navigateTo(this.getAttribute('href').substring(1)); document.getElementById('mobile-menu').classList.add('hidden'); }));
            document.getElementById('login-btn').addEventListener('click', () => document.getElementById('login-modal').classList.remove('hidden'));
            document.getElementById('cancel-login-btn').addEventListener('click', () => document.getElementById('login-modal').classList.add('hidden'));
            document.getElementById('submit-login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('save-changes-btn').addEventListener('click', saveContentChanges);
            document.getElementById('exit-admin-btn').addEventListener('click', handleLogout);
            document.getElementById('lightbox-close').addEventListener('click', () => document.getElementById('lightbox').classList.add('hidden'));
            document.getElementById('admin-event-form-container').addEventListener('submit', handleEventFormSubmit);
            document.getElementById('admin-event-form-container').addEventListener('click', (e) => { if (e.target.id === 'cancel-edit-btn') resetEventForm(); });
            document.getElementById('main-content').addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('[data-toggle-details]');
                if (toggleBtn) {
                    const eventId = toggleBtn.dataset.toggleDetails;
                    const detailsDiv = document.getElementById(`details-${eventId}`);
                    const icon = toggleBtn.querySelector('i');
                    if (detailsDiv) {
                        icon?.classList.toggle('rotate-180');
                        detailsDiv.style.maxHeight = detailsDiv.style.maxHeight ? null : detailsDiv.scrollHeight + "px";
                    }
                }
                 if (e.target.closest('.verein-tab-btn')) {
                    const btn = e.target.closest('.verein-tab-btn');
                    document.querySelectorAll('.verein-tab-btn').forEach(b => { b.classList.remove('bg-blue-500', 'text-white'); b.classList.add('bg-gray-200', 'dark:bg-gray-700'); });
                    btn.classList.add('bg-blue-500', 'text-white'); btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    renderVereinContent(btn.dataset.vereinTab);
                }
                if (e.target.closest('.brauchtum-tab-btn')) {
                    const btn = e.target.closest('.brauchtum-tab-btn');
                    document.querySelectorAll('.brauchtum-tab-btn').forEach(b => { b.classList.remove('bg-blue-500', 'text-white'); b.classList.add('bg-gray-200', 'dark:bg-gray-700'); });
                    btn.classList.add('bg-blue-500', 'text-white'); btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    renderBrauchtumContent(btn.dataset.brauchtumTab);
                }
            });
             document.querySelector('#member-area .flex').addEventListener('click', (e) => {
                if (e.target.closest('.member-tab-btn')) {
                    const btn = e.target.closest('.member-tab-btn');
                    document.querySelectorAll('#member-area .member-tab-btn').forEach(b => { b.classList.remove('bg-blue-500', 'text-white'); b.classList.add('bg-gray-200', 'dark:bg-gray-700'); });
                    btn.classList.add('bg-blue-500', 'text-white'); btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    renderMemberContent(btn.dataset.memberTab);
                }
            });
            document.getElementById('member-content').addEventListener('submit', handleMemberAreaSubmits);
            document.getElementById('member-content').addEventListener('click', handleMemberAreaClicks);
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.add('hidden'));
            let targetSection = document.getElementById(pageId);
            if (!targetSection) {
                if(document.querySelector(`[data-verein-tab="${pageId}"]`)) targetSection = document.getElementById('verein');
                else if(document.querySelector(`[data-brauchtum-tab="${pageId}"]`)) targetSection = document.getElementById('brauchtum');
                else if(document.querySelector(`[data-member-tab="${pageId}"]`)) targetSection = document.getElementById('member-area');
                else targetSection = document.getElementById('home');
            }
            if (targetSection) targetSection.classList.remove('hidden');
            if (targetSection && targetSection.id === 'home') document.getElementById('home-intro').classList.remove('hidden');

            if (state.authLevel !== 'public' && (pageId ==='koenigstipp' || pageId === 'dienstplan' || pageId === 'dokumente')) {
                 document.getElementById('member-area').classList.remove('hidden');
            } else if (state.authLevel === 'public') {
                document.getElementById('member-area').classList.add('hidden');
            }
            window.history.pushState(null, '', `#${pageId}`);
            window.scrollTo(0,0);
        }

        function handleLogin() {
            const password = document.getElementById('password-input').value;
            if (password === 'admin123') state.authLevel = 'admin';
            else if (password === 'member123') state.authLevel = 'member';
            else { document.getElementById('login-error').classList.remove('hidden'); return; }
            showToast('Login erfolgreich!');
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('password-input').value = '';
            document.getElementById('login-error').classList.add('hidden');
            updateUIforAuthState();
        }

        function handleLogout() {
            state.authLevel = 'public';
            updateUIforAuthState();
            showToast('Erfolgreich ausgeloggt.');
            navigateTo('home');
        }
        
        function updateUIforAuthState() {
            document.getElementById('login-btn').classList.toggle('hidden', state.authLevel !== 'public');
            document.getElementById('logout-btn').classList.toggle('hidden', state.authLevel === 'public');
            document.body.classList.toggle('jgv-editing', state.authLevel === 'admin');
            document.body.classList.toggle('pt-12', state.authLevel === 'admin');
            document.getElementById('admin-bar').classList.toggle('hidden', state.authLevel !== 'admin');
            document.querySelectorAll('.jgv-editable').forEach(el => el.setAttribute('contenteditable', state.authLevel === 'admin'));
            if(state.authLevel === 'admin') renderAdminEventForm(); else document.getElementById('admin-event-form-container').innerHTML = '';
            renderTimeline();
            renderCurrentTabs();
        }

        async function saveContentChanges() {
            const newContent = { ...state.content };
            document.querySelectorAll('.jgv-editable').forEach(el => { const id = el.id || el.dataset.id; if (id) newContent[id] = el.innerHTML; });
            await updateDoc(doc(db, "jgv-website-data", appId), { content: newContent });
            showToast('Änderungen gespeichert!');
        }
        
        function renderAdminEventForm() {
            const container = document.getElementById('admin-event-form-container');
            container.innerHTML = `<form id="event-form" class="max-w-xl mx-auto my-6 bg-gray-100 dark:bg-gray-800 p-6 rounded-lg shadow-md text-left"><h3 id="event-form-title" class="text-xl font-bold mb-4">Neuen Termin hinzufügen</h3><input type="hidden" id="event-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="event-title" placeholder="Titel" required class="p-2 rounded border dark:bg-gray-700 dark:border-gray-600"><input type="date" id="event-date" required class="p-2 rounded border dark:bg-gray-700 dark:border-gray-600"></div><textarea id="event-desc" placeholder="Kurzbeschreibung" rows="3" class="w-full mt-4 p-2 rounded border dark:bg-gray-700"></textarea><textarea id="event-details" placeholder="Detaillierte Infos (optional)" rows="5" class="w-full mt-4 p-2 rounded border dark:bg-gray-700"></textarea><div class="mt-4 flex items-center justify-between"><label class="flex items-center select-none"><input type="checkbox" id="event-internal" class="mr-2 h-4 w-4"> Intern</label><div class="flex gap-2"><button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Abbrechen</button><button type="submit" id="event-submit-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Hinzufügen</button></div></div></form>`;
        }

        async function handleEventFormSubmit(e) {
            e.preventDefault();
            const eventId = document.getElementById('event-id').value;
            const eventData = { title: document.getElementById('event-title').value, date: document.getElementById('event-date').value, description: document.getElementById('event-desc').value, details: document.getElementById('event-details').value, type: document.getElementById('event-internal').checked ? 'internal' : 'public' };
            if (eventId) {
                await updateDoc(doc(db, `jgv-website-data/${appId}/events`, eventId), eventData);
                showToast('Termin aktualisiert!');
            } else {
                await addDoc(collection(db, `jgv-website-data/${appId}/events`), eventData);
                showToast('Termin hinzugefügt!');
            }
            resetEventForm();
        }

        function resetEventForm() {
            const form = document.getElementById('event-form');
            if (form) {
                form.reset();
                document.getElementById('event-id').value = '';
                document.getElementById('event-form-title').textContent = 'Neuen Termin hinzufügen';
                document.getElementById('event-submit-btn').textContent = 'Hinzufügen';
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            }
        }
        
        window.openEventEditor = (eventId) => {
            const event = state.events.find(e => e.id === eventId);
            if (!event) return;
            const form = document.getElementById('event-form');
            if (!form) renderAdminEventForm();
            document.getElementById('event-form-title').textContent = 'Termin bearbeiten';
            document.getElementById('event-id').value = event.id;
            document.getElementById('event-title').value = event.title;
            document.getElementById('event-date').value = event.date;
            document.getElementById('event-desc').value = event.description;
            document.getElementById('event-details').value = event.details || '';
            document.getElementById('event-internal').checked = event.type === 'internal';
            document.getElementById('event-submit-btn').textContent = 'Aktualisieren';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        window.deleteEvent = async (eventId) => {
            if (confirm('Soll dieser Termin wirklich gelöscht werden?')) {
                 await deleteDoc(doc(db, `jgv-website-data/${appId}/events`, eventId));
                 showToast('Termin gelöscht.');
            }
        };

        async function handleMemberAreaSubmits(e) {
            e.preventDefault();
            const dataDocRef = doc(db, "jgv-website-data", appId);
            if (e.target.id === 'koenigstipp-form') {
                const user = document.getElementById('tipp-user').value.trim();
                const tip = document.getElementById('tipp-guess').value.trim();
                if (user && tip) {
                    const newTips = [...(state.memberData.koenigstipp.tips || []), { user, tip }];
                    await updateDoc(dataDocRef, { 'memberData.koenigstipp.tips': newTips });
                    showToast('Tipp abgegeben!');
                    e.target.reset();
                }
            }
        }

        async function handleMemberAreaClicks(e) {
            const dataDocRef = doc(db, "jgv-website-data", appId);
            if (e.target.closest('.dienstplan-slot')) {
                const slotId = e.target.closest('.dienstplan-slot').dataset.slotId;
                if (state.memberData.dienstplan[slotId]) {
                    if (state.authLevel === 'admin') {
                        await updateDoc(dataDocRef, { [`memberData.dienstplan.${slotId}`]: null });
                    } else { showToast('Nur Admins können Einträge entfernen.', 'error'); }
                } else {
                    const name = prompt('Dein Name für die Schicht:');
                    if (name) await updateDoc(dataDocRef, { [`memberData.dienstplan.${slotId}`]: name.trim() });
                }
            }
            if (e.target.id === 'toggle-tipp-lock') {
                await updateDoc(dataDocRef, { 'memberData.koenigstipp.locked': !state.memberData.koenigstipp.locked });
            }
            if (e.target.id === 'declare-winner-btn') {
                const winner = prompt('Wer ist der Gewinner?');
                if (winner) await updateDoc(dataDocRef, { 'memberData.koenigstipp.winner': winner, 'memberData.koenigstipp.locked': true });
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>

